<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">
    <h:head>
        <title>Oops | RÃ©sultats</title>
        <link href='https://fonts.googleapis.com/css?family=Kavoon' rel='stylesheet' type='text/css'/>
        <link href="style/style2.css" rel="stylesheet" type="text/css" />
         <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
        <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    </h:head>
    <h:body>   
        <ui:include src="header.xhtml"/>
        <ui:include src="search.xhtml"/>
        <div id="featured-wrapper">
            <div id ="content">
                <div id="featured" class="container">
                    <h:messages />
                    <header>
                        <h:outputText id="nbResult" value="#{searchBean.nbResult}" />
                     </header>
                    <ui:repeat value="#{searchBean.prestataires}" var="pres">
                        <div class="prestataire">    
                                <h:form>
                                    <h:link outcome="fiche.xhtml">
                                        <f:param name="page" value="#{pres.login}"/>
                                        <h:outputText value="#{pres.nomEntreprise}"/>
                                    </h:link>
                                </h:form>
                            
                            <h:form><p:rating value="#{pres.average}" readonly="true"/></h:form>
                            <div id="rating"><a href="#">#{pres.nbAvis} avis</a></div><br/><br/>|
                                    
                                <ui:repeat value="#{pres.adresses}" var="address">
                                    <h:column>
                                        <h:outputText value="#{address.ville}" style="font-weight: bold"/>
                                        <h:outputText value=" (#{address.codePostal}) |"/>                  
                                    </h:column>
                                </ui:repeat>
                            <br/><br/>
                            <h:outputText value="Description : #{pres.description}" />
                        </div>
                    </ui:repeat>
                </div>
                
                <div id="map" style="width: 100%; height: 600px; margin-top: 5%"></div>

                <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
                <script>
                    var access = 'pk.eyJ1IjoiamVzdXNib3ZlIiwiYSI6ImNpajR2czhlYzAwMjB3M20zOHk2dnBjcWoifQ.PUlh2thCN1c5zl3setgtTQ';
                    var mapboxTiles = L.tileLayer('https://api.mapbox.com/v4/mapbox.streets-basic/{z}/{x}/{y}.png256?access_token=' + access, {
                        attribution: '<a href="http://www.mapbox.com/about/maps/" target="_blank">Terms &amp; Feedback</a>'
                    });
                    var map = L.map('map').addLayer(mapboxTiles).setView([46.92026, 3.16406], 5);</script>

                <h:form id="m">
                    <ui:repeat value="#{searchBean.prestataires}" var="pres">
                        <h:inputHidden id="p" value="#{pres.nomEntreprise}" />
                        <p> 
                            
                            <ui:repeat value="#{pres.adresses}" var="adresse">
                                
                                <h:inputHidden id="name" value="#{pres.nomEntreprise}"/>
                                <script>
                                    var template = "<h1>#{pres.nomEntreprise}</h1><p>#{pres.description}</p><ul>";
                                    <ui:repeat value = "#{pres.categories}" var = "cat">
                                        template += "<li> #{cat.nom} </li>";
                                    </ui:repeat>

                                    template += "</ul>";
                                    L.marker([#{adresse.latitude}, #{adresse.longitude}]).addTo(map).bindPopup(template).on('click', function (e) {
                                        document.location.href = "fiche.xhtml?page=#{pres.login}";
                                    }).on('mouseover', function (e) {
                                        this.openPopup();
                                    }).on('mouseout', function (e) {
                                        this.closePopup();
                                    });
                                </script> 
                            </ui:repeat>
                        </p>
                    </ui:repeat>
                </h:form>

                <br/>
            </div>
        </div>
        <ui:include src="footer.xhtml"/>
    </h:body>
</html>
