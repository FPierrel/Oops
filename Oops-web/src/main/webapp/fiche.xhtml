<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
      xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
      xmlns:pe="http://primefaces.org/ui/extensions">>
    <f:metadata>
        <f:viewParam name="page" value="#{ficheBean.page}" />
        <f:viewParam name="page" value="#{reportBean.page}" />
        <f:viewParam name="page" value="#{photoBean.page}" />
        <f:viewAction action="#{ficheBean.init}" />

        <f:viewAction action="#{photoBean.initAlternative}" />
    </f:metadata>
    <h:head>
        <title>Oops | #{ficheBean.prestataire.nomEntreprise}</title>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <link href="css/bootstrap.min.css" rel="stylesheet"/>
        <link href="css/font-awesome.min.css" rel="stylesheet"/>
        <link href="css/prettyPhoto.css" rel="stylesheet"/>
        <link href="css/animate.css" rel="stylesheet"/>
        <link href="css/main.css" rel="stylesheet"/>
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css"/>
        <link href="css/starrr.css" rel="stylesheet"/>
        <!--[if lt IE 9]>
        <script src="js/html5shiv.js"></script>
        <script src="js/respond.min.js"></script>
        <![endif]-->       
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="images/ico/apple-touch-icon-144-precomposed.png"/>
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="images/ico/apple-touch-icon-114-precomposed.png"/>
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="images/ico/apple-touch-icon-72-precomposed.png"/>
        <link rel="apple-touch-icon-precomposed" href="images/ico/apple-touch-icon-57-precomposed.png"/>
    </h:head>
    <h:body>
        <ui:include src="header.xhtml"/>
        <ui:include src="search.xhtml"/>


        <section id="blog" class="container">
            <div class="row">
                <p:messages />
                <aside class="col-sm-4 col-sm-push-8">

                    <div class="widget tags">
                        <h3>Catégories</h3>
                        <ul class="tag-cloud">
                            <span id="categories">
                                <br/>
                                <ui:repeat value="#{ficheBean.categories}" var="categorie">
                                    <li><a class="btn btn-xs btn-primary" href="#">#{categorie}</a></li>
                                </ui:repeat>
                            </span>
                        </ul>
                    </div><!--/.tags-->

                    <div class="widget ads">
                        <div class="row">
                            <div class="col-xs-6">
                                <a href="#"><img class="img-responsive img-rounded" src="images/ads/ad1.png" alt=""/></a>
                            </div>

                            <div class="col-xs-6">
                                <a href="#"><img class="img-responsive img-rounded" src="images/ads/ad2.png" alt=""/></a>
                            </div>
                        </div>
                        <p> </p>
                        <div class="row">
                            <div class="col-xs-6">
                                <a href="#"><img class="img-responsive img-rounded" src="images/jose.jpg" alt=""/></a>
                            </div>

                            <div class="col-xs-6">
                                <a href="#"><img class="img-responsive img-rounded" src="images/ads/ad4.png" alt=""/></a>
                            </div>
                        </div>
                    </div><!--/.ads--> 

                    <div class="widget">
                        <h3>Contacts</h3>
                        <div class="widget-content">
                            <h4><h:outputText value="#{ficheBean.prestataire.prenom} #{ficheBean.prestataire.nom}"/></h4>
                            <ui:repeat value="#{ficheBean.prestataire.adresses}" var="address">
                                <h:column>
                                    <p>
                                        <h:outputText value="#{address.numero}, "/>                  
                                        <h:outputText value="#{address.rue}"/><br/>         
                                        <c:if test="!#{address.complement}.isEmpty()"><h:outputText value="#{address.complement}"/><br/></c:if>       
                                        <h:outputText value="#{address.codePostal} "/>                  
                                        <h:outputText value="#{address.ville}"/>
                                    </p>                
                                </h:column>
                            </ui:repeat>
                            <p>
                                <h:outputText value="Téléphone : #{ficheBean.prestataire.numeroTelephone}"/><br/>
                                <h:outputText value="E-mail : #{ficheBean.prestataire.mail}"/><br/>
                                <h:outputText id="website" value="Site Web : #{ficheBean.prestataire.siteWeb}"/><br/>
                            </p>
                        </div>

                        <div class="widget">
                            <h3>Informations supplémentaires</h3>
                            <div class="widget-content">
                                <p>
                                    <h:outputText value="Raison sociale : A DEFINIR ! "/><br/>
                                    <h:outputText value="Forme juridique : A DEFINIR ! "/><br/>
                                    <h:outputText id="employeeNumber" value="Nombre d'employé(s) : #{ficheBean.prestataire.nbEmployes} "/><br/>
                                    <h:outputText id="turnover" value="Chiffre d'affaire : #{ficheBean.prestataire.chiffreAffaire} € "/>
                                </p>
                            </div>
                        </div>
                    </div>
                </aside>        
                <div class="col-sm-8 col-sm-pull-4">
                    <div class="blog">
                        <div class="blog-item">
                            <img class="img-responsive img-blog" src="images/blog/blog2.jpg" width="100%" alt="" />
                            <div class="blog-content">

                                <h:form id="banish" rendered="#{request.isUserInRole('ADMINISTRATEUR')}">
                                    <p:commandButton rendered="#{!reportBean.banished}" actionListener="#{reportBean.banishPrestataire()}" value="Bannir" ><f:ajax render="banish"/></p:commandButton> <p:commandButton rendered="#{reportBean.banished}" actionListener="#{reportBean.redeemPrestataire()}" value="Gracier" ><f:ajax render="banish"/></p:commandButton>
                                </h:form>

                                <h:form id="reportFiche" rendered="#{request.remoteUser != null}"> 
                                    <p:commandLink id="reportFiche" onclick="PF('toggleReportFiche').toggle()" value="Signaler cette fiche"/><p:panel style="background-color:#ededed; border:0px" collapsed="true" toggleable="true" widgetVar="toggleReported">Votre signalement sera bientôt traité par un administrateur</p:panel>
                                    <p:panel style="background-color:#ededed; border:0px" collapsed="true" toggleable="true" closable="true" widgetVar="toggleReportFiche">
                                        <h:selectOneMenu id="reasons" value="#{reportBean.reason}" required = "true" > 
                                            <f:selectItems value="#{reportBean.reasons}"/>
                                        </h:selectOneMenu><br/>
                                        <p:inputTextarea value="#{reportBean.complement}" id="reportFicheReason" placeholder="Complément"/>
                                        <br/><p:commandButton value="Signaler" id="reportFicheButton" onclick="PF('toggleReportFiche').toggle();
                                                PF('toggleReported').toggle()" actionListener="#{reportBean.reportFiche()}"/>
                                    </p:panel>
                                </h:form>

                                <h:form id="formNotes">
                                    <h3><h:outputText id="companyName" value="#{ficheBean.prestataire.nomEntreprise}"/></h3>
                                    <div class='starrr' id="star_moyenne"></div><h:outputText value=" (#{ficheBean.noteTotal})"/>
                                    <div class="entry-meta">
                                        <span><i class="icon-user"></i><h:outputText value=" #{ficheBean.prestataire.prenom} #{ficheBean.prestataire.nom}"/></span>
                                        <span><i class="icon-calendar"></i> DATE D'INSCRIPTION</span>
                                        <span><i class="icon-comment"></i> <a href="#comments">#{ficheBean.nbAvis} Avis</a></span>
                                    </div>
                                    <fieldset>
                                        <legend>Description</legend>
                                        <p class="lead"><h:outputText id="description" value="#{ficheBean.prestataire.description}"/></p>
                                    </fieldset>
                                    <fieldset>
                                        <legend>Evaluation</legend>
                                        <h:inputHidden id="moyenne" value="#{ficheBean.noteTotal}"/>
                                        <p>Moyenne : </p><div class='starrr' id="eval_moyenne"/><h:outputText value=" (#{ficheBean.noteTotal})"/>
                                        <h:inputHidden id="communication" value="#{ficheBean.noteGlobCom}"/>
                                        <p>Communication : </p><div class='starrr' id="eval_communication"></div><h:outputText value=" (#{ficheBean.noteGlobCom})"/>
                                        <h:inputHidden id="delai" value="#{ficheBean.noteGlobDelai}"/>
                                        <p>Délai : </p><div class='starrr' id="eval_delai"></div><h:outputText value=" (#{ficheBean.noteGlobDelai})"/>
                                        <h:inputHidden id="prix" value="#{ficheBean.noteGlobPrix}"/>
                                        <p>Prix : </p><div class='starrr' id="eval_prix"></div><h:outputText value=" (#{ficheBean.noteGlobPrix})"/>
                                        <h:inputHidden id="qualite" value="#{ficheBean.noteGlobQualite}"/>
                                        <p>Qualité : </p><div class='starrr' id="eval_qualite"></div><h:outputText value=" (#{ficheBean.noteGlobQualite})"/>
                                    </fieldset>
                                    <br/>
                                </h:form>
                                <fieldset>
                                    <legend>Avis</legend>
                                </fieldset>
                                <div id="comments">
                                    <div id="comments-list">
                                        <h3>#{ficheBean.nbAvis} Avis</h3>
                                        <ui:repeat id="ravis" value="#{ficheBean.getlAvis()}" var="cAvis" varStatus="loop">
                                            <h:form id="lAvis#{loop.index}">
                                                <div class="media">
                                                    <div class="pull-left">
                                                        <img class="avatar img-circle" src="images/blog/avatar1.png" alt=""/>
                                                    </div>
                                                    <div class="media-body">
                                                        <div class="well well-avis">
                                                            <div class="media-heading">
                                                                <strong>#{cAvis.owner.login}</strong>&nbsp; <small>#{cAvis.dateFormat}</small>
                                                                <h:commandLink id="removeButton" class="pull-right" action="#{ficheBean.removeOpinion(cAvis)}" rendered="#{request.remoteUser == cAvis.owner.login}">
                                                                    <i class="icon-remove"></i> Supprimer
                                                                    <f:ajax execute="@form" render="@all" />
                                                                </h:commandLink>
                                                                <h:outputText class="pull-right" value=" &nbsp; "/>
                                                                <a class="pull-right" href="#repondre_avis" onclick="showRepondre('repondre_avis#{loop.index}')"><i class="icon-repeat"></i> Répondre</a>
                                                            </div>
                                                            <h:inputHidden id="a_comm" value="#{cAvis.noteCom}"/>
                                                            <p>Communication :<div class='starrr' id="avis_comm#{loop.index}"/><h:outputText value=" (#{cAvis.noteCom})"/></p>
                                                            <h:inputHidden id="a_delai" value="#{cAvis.noteDelai}"/>
                                                            <p>Délai : <div class='starrr' id="avis_delai#{loop.index}"/><h:outputText value=" (#{cAvis.noteDelai})"/></p>
                                                            <h:inputHidden id="a_prix" value="#{cAvis.notePrix}"/>
                                                            <p>Prix : <div class='starrr' id="avis_prix#{loop.index}"/><h:outputText value=" (#{cAvis.notePrix})"/></p>
                                                            <h:inputHidden id="a_qual" value="#{cAvis.noteQualite}"/>
                                                            <p>Qualité : <div class='starrr' id="avis_qualite#{loop.index}"/><h:outputText value=" (#{cAvis.noteQualite})"/></p>
                                                            <hr/>
                                                            <p><h:outputText id="contenu" value="#{cAvis.contenu}"/></p>
                                                        </div>
                                                        <ui:repeat value="#{cAvis.commentaires}" var="comm" varStatus="i">
                                                            <div class="media">
                                                                <div class="pull-left">
                                                                    <img class="avatar img-circle" src="images/blog/avatar3.png" alt=""/>
                                                                </div>
                                                                <div class="media-body">
                                                                    <div class="well">
                                                                        <div class="media-heading">
                                                                            <strong>#{comm.profil}</strong>&nbsp; <small>#{comm.dateFormat}</small>
                                                                            <h:commandLink rendered="#{request.remoteUser == comm.profil}" id="removeComButton" class="pull-right" action="#{ficheBean.removeComment(comm,loop.index)}">
                                                                                <i class="icon-remove"></i> Supprimer
                                                                                <f:ajax execute="@form" render="@all" />
                                                                            </h:commandLink>
                                                                        </div>
                                                                        <p><h:outputText value="#{comm.contenu}"/></p>
                                                                    </div>
                                                                </div>
                                                            </div><!--/.media-->
                                                        </ui:repeat>
                                                        <div id="repondre_avis#{loop.index}" style="display: none">
                                                            <div class="form-group">
                                                                <input class="form-control" type="text" id="co#{loop.index}" name="co#{loop.index}" placeholder="Réponse"/>
                                                                <h:commandLink class="btn btn-default btn-md btn-block" action="#{ficheBean.saveComment(loop.index)}">
                                                                    Répondre
                                                                    <f:ajax execute="@form" render="@all" />
                                                                </h:commandLink>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div><!--/.media-->
                                                <script>
                                                    $('#avis_comm#{loop.index}').starrr({
                                                        readOnly: true,
                                                        rating: document.getElementById('ravis:#{loop.index}:lAvis:a_comm').value
                                                    });
                                                    $('#avis_delai#{loop.index}').starrr({
                                                        readOnly: true,
                                                        rating: document.getElementById('ravis:#{loop.index}:lAvis:a_delai').value
                                                    });
                                                    $('#avis_prix#{loop.index}').starrr({
                                                        readOnly: true,
                                                        rating: document.getElementById('ravis:#{loop.index}:lAvis:a_prix').value
                                                    });
                                                    $('#avis_qualite#{loop.index}').starrr({
                                                        readOnly: true,
                                                        rating: document.getElementById('ravis:#{loop.index}:lAvis:a_qual').value
                                                    });
                                                </script>
                                            </h:form>
                                        </ui:repeat>
                                    </div><!--/#comments-list-->  

                                    <div id="comment-form">
                                        <h3>Donnez votre avis</h3>
                                        <c:if test="#{request.remoteUser == null}">
                                            <h:outputText value="Connectez-vous pour laisser un avis !"/>
                                        </c:if>
                                        <h:form id="formOpinion" class="form-horizontal" rendered="#{request.remoteUser != null}">
                                            <div class="form-group">
                                                <div class="col-sm-6">
                                                    <h:inputHidden id="new_a_delai" value="#{ficheBean.rate4}"/>
                                                    <div class='starrr' id="s_new_a_delai"/> (Délai)
                                                </div>
                                                <div class="col-sm-6">
                                                    <h:inputHidden id="new_a_comm" value="#{ficheBean.rate1}"/>
                                                    <div class='starrr' id="s_new_a_comm"/> (Communication)
                                                </div>
                                                <div class="col-sm-6">
                                                    <h:inputHidden id="new_a_prix" value="#{ficheBean.rate3}"/>
                                                    <div class='starrr' id="s_new_a_prix"/> (Prix)
                                                </div>
                                                <div class="col-sm-6">
                                                    <h:inputHidden id="new_a_qual" value="#{ficheBean.rate2}"/>
                                                    <div class='starrr' id="s_new_a_qual"/> (Qualité)
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="col-sm-12">
                                                    <h:inputTextarea value="#{ficheBean.opinion}" id="opinion" rows="8" class="form-control" pt:placeholder="Commentaire sur la prestation..."/>
                                                </div>
                                            </div>
                                            <h:commandButton id="opinionButton" value="Soumettre l'avis" class="btn btn-danger btn-lg" action="#{ficheBean.saveOpinion()}">
                                                <f:ajax execute="@form" render="@all" />
                                            </h:commandButton>
                                        </h:form>
                                    </div><!--/#comment-form-->
                                </div><!--/#comments-->
                            </div>
                        </div><!--/.blog-item-->
                    </div>
                </div><!--/.col-md-8-->
            </div><!--/.row-->
        </section><!--/#blog-->

        <c:if test="#{photoBean.photos != null}">        
                    <pe:fluidGrid value="#{photoBean.photosGrid}" var="photo" hasImages="true">  
                        <pe:fluidGridItem class="col-md-4">   
                            <a href="#" class="thumbnail" style="margin-top: 10px; margin-left: 10px">
                                <img src="#{photo}"/>
                            </a>
                        </pe:fluidGridItem>  
                    </pe:fluidGrid>  
        </c:if>

        <ui:include src="footer.xhtml"/>

        <script src="js/bootstrap.min.js"></script>
        <script src="js/jquery.prettyPhoto.js"></script>
        <script src="js/main.js"></script>
        <script src="js/starrr.js"></script>
        <script>
                                                    $('#star_moyenne').starrr({
                                                        readOnly: true,
                                                        rating: document.getElementById('formNotes:moyenne').value
                                                    });
                                                    $('#eval_moyenne').starrr({
                                                        readOnly: true,
                                                        rating: document.getElementById('formNotes:moyenne').value
                                                    });
                                                    $('#eval_communication').starrr({
                                                        readOnly: true,
                                                        rating: document.getElementById('formNotes:communication').value
                                                    });
                                                    $('#eval_delai').starrr({
                                                        readOnly: true,
                                                        rating: document.getElementById('formNotes:delai').value
                                                    });
                                                    $('#eval_prix').starrr({
                                                        readOnly: true,
                                                        rating: document.getElementById('formNotes:prix').value
                                                    });
                                                    $('#eval_qualite').starrr({
                                                        readOnly: true,
                                                        rating: document.getElementById('formNotes:qualite').value
                                                    });
                                                    $('#s_new_a_delai').starrr({
                                                        change: function (e, value) {
                                                            if (value) {
                                                                document.getElementById('formOpinion:new_a_delai').value = value;
                                                            } else {
                                                                document.getElementById('formOpinion:new_a_delai').value = 0;
                                                            }
                                                        }
                                                    });
                                                    $('#s_new_a_comm').starrr({
                                                        change: function (e, value) {
                                                            if (value) {
                                                                document.getElementById('formOpinion:new_a_comm').value = value;
                                                            } else {
                                                                document.getElementById('formOpinion:new_a_comm').value = 0;
                                                            }
                                                        }
                                                    });
                                                    $('#s_new_a_prix').starrr({
                                                        change: function (e, value) {
                                                            if (value) {
                                                                document.getElementById('formOpinion:new_a_prix').value = value;
                                                            } else {
                                                                document.getElementById('formOpinion:new_a_prix').value = 0;
                                                            }
                                                        }
                                                    });
                                                    $('#s_new_a_qual').starrr({
                                                        change: function (e, value) {
                                                            if (value) {
                                                                document.getElementById('formOpinion:new_a_qual').value = value;
                                                            } else {
                                                                document.getElementById('formOpinion:new_a_qual').value = 0;
                                                            }
                                                        }
                                                    });
        </script>
        <script>
            function showRepondre(box) {
                if (document.getElementById(box).style.display === "none") {
                    vis = "block";
                } else {
                    vis = "none";
                }
                document.getElementById(box).style.display = vis;
            }
        </script>
    </h:body>
</html>
